
<!DOCTYPE html>
<html lang="bn">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <title>Earn & Reward App</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />

  <style>
/* === THEME TOKENS (unchanged) === */
:root{
  --font-family:'Nunito',sans-serif;
  --bg-color-light:#f4f4f9; --secondary-bg-light:#fff; --text-color-light:#1c1c1e; --subtle-text-light:#6d6d72; --primary-color-light:#007aff; --border-color-light:#e0e0e0;
  --bg-color-dark:#121212;  --secondary-bg-dark:#1c1c1e;  --text-color-dark:#fff;   --subtle-text-dark:#8e8e93;  --primary-color-dark:#0a84ff;  --border-color-dark:#38383a;
}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:var(--font-family);transition:background-color .3s,color .3s;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}
body.light-theme{background:#f4f4f9;color:#1c1c1e}
body.dark-theme{background:#121212;color:#fff}
#app{max-width:500px;margin:0 auto;padding-bottom:86px}

/* ===== Premium Loader Overlay (boot) ===== */
#boot-overlay{
  position:fixed;inset:0;z-index:3000;display:flex;align-items:center;justify-content:center;
  background:radial-gradient(1000px 600px at 80% -10%, rgba(124,77,255,.18), transparent 60%),
             radial-gradient(800px 500px at 10% 120%, rgba(46,221,235,.12), transparent 60%),
             rgba(0,0,0,.65);
  backdrop-filter:saturate(160%) blur(6px);
}
.boot-card{
  width:90%;max-width:420px;padding:28px;border-radius:18px;text-align:center;
  background:linear-gradient(180deg,#1c1c1e,#141414);border:1px solid rgba(255,255,255,.08);color:#fff;
  box-shadow:0 24px 60px rgba(0,0,0,.45);
}
.boot-logo{
  width:66px;height:66px;border-radius:50%;display:grid;place-items:center;margin:0 auto 14px;
  background:conic-gradient(from 0deg, #6d5dfc, #4f46e5, #30d158, #6d5dfc);
  animation:spin 2.2s linear infinite;
}
.boot-logo i{font-size:28px;color:#fff}
.boot-title{font-weight:800;font-size:1.1rem;margin-bottom:6px}
.boot-sub{opacity:.85;font-size:.95rem}
.boot-progress{height:6px;border-radius:999px;background:rgba(255,255,255,.12);margin:16px 0 4px;overflow:hidden}
.boot-bar{height:100%;width:20%;border-radius:999px;background:linear-gradient(90deg,#6d5dfc,#4f46e5);animation:loaderBar 1.5s ease-in-out infinite}
.boot-hint{opacity:.8;font-size:.85rem}
@keyframes loaderBar{0%{transform:translateX(-30%)}50%{transform:translateX(70%)}100%{transform:translateX(130%)}}
@keyframes spin{to{transform:rotate(360deg)}}

/* ===== Skeletons (shimmer) ===== */
.skel{position:relative;overflow:hidden;background:rgba(255,255,255,.04);border-radius:10px}
.skel::after{
  content:"";position:absolute;inset:0;
  background:linear-gradient(90deg, transparent, rgba(255,255,255,.12), transparent);
  transform:translateX(-100%);animation:shimmer 1.4s infinite;
}
@keyframes shimmer{100%{transform:translateX(100%)}}
.skel-avatar{width:60px;height:60px;border-radius:50%}
.skel-line{height:14px;border-radius:6px}
.skel-line.w60{width:60%}.skel-line.w40{width:40%}.skel-line.w80{width:80%}

/* ===== Header / Cards ===== */
.profile-header{padding:20px 15px;display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid}
.light-theme .profile-header{border-bottom-color:#e0e0e0}
.dark-theme  .profile-header{border-bottom-color:#38383a}
.profile-info{display:flex;align-items:center;gap:15px}
#user-photo{width:60px;height:60px;border-radius:50%;object-fit:cover;border:2px solid}
.light-theme #user-photo{border-color:#007aff}
.dark-theme  #user-photo{border-color:#0a84ff}
.user-details h1{font-size:1.2rem;font-weight:700}
.verified-icon{font-size:1rem;margin-left:5px}
.light-theme .verified-icon{color:#007aff}
.dark-theme  .verified-icon{color:#0a84ff}
.user-details p{font-size:.9rem;font-weight:600}
.light-theme .user-details p{color:#6d6d72}
.dark-theme  .user-details p{color:#8e8e93}
.mini-app-badge{display:none;align-items:center;gap:8px;padding:6px 12px;border-radius:999px;font-weight:800;font-size:.75rem;border:1px solid}
.light-theme .mini-app-badge{background:#eef6ff;color:#0a3d8f;border-color:#bcd8ff}
.dark-theme  .mini-app-badge{background:#0b2545;color:#cfe6ff;border-color:#123}

main{padding:15px}
.page{display:none}
.page.active{display:block;animation:fadeIn .3s ease-in-out}
@keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
h2{font-size:1.5rem;margin-bottom:15px}

.stats-grid{display:grid;grid-template-columns:1fr 1fr;gap:15px;margin-top:20px}
.stat-card{padding:20px;border-radius:12px;text-align:center}
.light-theme .stat-card{background:#fff;border:1px solid #e0e0e0}
.dark-theme  .stat-card{background:#1c1c1e;border:1px solid #38383a}
.stat-card h3{font-size:.9rem;margin-bottom:10px}
.light-theme .stat-card h3{color:#6d6d72}
.dark-theme  .stat-card h3{color:#8e8e93}
.stat-card p{font-size:1.5rem;font-weight:700}
.light-theme .stat-card p{color:#007aff}
.dark-theme  .stat-card p{color:#0a84ff}

/* referral / tasks / buttons */
.referral-section{margin-top:30px;padding:20px;border-radius:12px}
.light-theme .referral-section{background:#fff;border:1px solid #e0e0e0}
.dark-theme  .referral-section{background:#1c1c1e;border:1px solid #38383a}
.referral-section h3{text-align:center}
#referral-link{width:100%;padding:10px;text-align:center;border:1px dashed;border-radius:8px;margin:10px 0;font-size:.9rem}
.light-theme #referral-link{border-color:#007aff;background:#f4f4f9;color:#1c1c1e}
.dark-theme  #referral-link{border-color:#0a84ff;background:#121212;color:#fff}
.ref-btns{display:flex;justify-content:center;gap:12px;margin-top:10px;flex-wrap:wrap}
.ref-btns button{flex:1;min-width:150px;padding:12px;border:none;border-radius:8px;color:#fff;cursor:pointer;font-weight:600}
.ref-text{text-align:center;margin-bottom:12px;opacity:.9;line-height:1.5}
.light-theme #copy-ref-link-btn{background:#007aff}
.dark-theme  #copy-ref-link-btn{background:#0a84ff}
.light-theme #share-on-telegram-btn{background:#34c759}
.dark-theme  #share-on-telegram-btn{background:#30d158}

.task-container{padding:20px;border-radius:12px;text-align:center;margin-bottom:20px}
.task-container:last-child{margin-bottom:0}
.light-theme .task-container{background:#fff;border:1px solid #e0e0e0}
.dark-theme  .task-container{background:#1c1c1e;border:1px solid #38383a}
.task-icon{font-size:3rem;margin-bottom:15px}
.light-theme .task-icon{color:#007aff}
.dark-theme  .task-icon{color:#0a84ff}
.task-container h3{font-size:1.2rem;margin-bottom:5px}
.task-container p{font-size:.9rem;margin-bottom:15px}
.light-theme .task-container p{color:#6d6d72}
.dark-theme  .task-container p{color:#8e8e93}

.action-btn{width:100%;padding:14px;font-size:1rem;font-weight:700;color:#fff;border:none;border-radius:10px;cursor:pointer;position:relative;display:flex;justify-content:center;align-items:center}
.light-theme .action-btn{background:#007aff}
.dark-theme  .action-btn{background:#0a84ff}
.action-btn:disabled{opacity:.6;cursor:not-allowed}
.btn-loader{width:20px;height:20px;border:3px solid rgba(255,255,255,.4);border-top-color:#fff;border-radius:50%;animation:spin 1s linear infinite;display:none}
.action-btn.loading .btn-text{visibility:hidden}
.action-btn.loading .btn-loader{display:block;position:absolute}

#ad-verify-hint{margin-bottom:8px;font-weight:700}
#ad-timer-note{margin-top:10px;font-size:.85rem;opacity:.8}

/* small ad modal */
.modal{display:none;position:fixed;z-index:2000;left:0;top:0;width:100%;height:100%;background:rgba(0,0,0,.6);justify-content:center;align-items:center}
.modal-content{padding:30px;border-radius:15px;text-align:center}
.light-theme .modal-content{background:#fff}
.dark-theme  .modal-content{background:#1c1c1e}
.loader{border:5px solid #f3f3f3;border-radius:50%;border-top:5px solid;width:40px;height:40px;animation:spin 1s linear infinite;margin:0 auto 15px}
.light-theme .loader{border-top-color:#007aff}
.dark-theme  .loader{border-top-color:#0a84ff}

/* News popup */
.news-overlay{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;z-index:2000}
.news-overlay.show{display:block}
.news-modal{position:fixed;z-index:2001;top:50%;left:50%;transform:translate(-50%,-50%);width:min(560px,calc(100% - 32px));border-radius:18px;background:#1c1c1e;border:1px solid rgba(255,255,255,.08);box-shadow:0 20px 60px rgba(0,0,0,.45);display:none}
body.light-theme .news-modal{background:#fff;border-color:#e7e7ef}
.news-modal.show{display:block}
.news-hero{position:relative;padding:20px 56px 10px 56px;display:flex;align-items:center;justify-content:center;gap:10px;background:linear-gradient(180deg, rgba(124,77,255,.15), transparent)}
.news-hero h3{margin:0;font-size:22px;font-weight:800;text-align:center}
.news-emoji{font-size:22px;line-height:1}
.news-close{position:absolute;top:10px;right:10px;width:36px;height:36px;display:grid;place-items:center;border-radius:10px;border:1px solid #38383a;background:transparent;color:#fff;cursor:pointer}
body.light-theme .news-close{color:#1c1c1e;border-color:#e0e0e0}
.news-body{padding:12px 22px 0 22px;text-align:center;line-height:1.7;font-size:15px;opacity:.95;white-space:pre-line}
.news-foot{padding:22px;display:flex;justify-content:center}
.btn-ok{width:100%;max-width:420px;padding:14px 18px;border-radius:12px;border:none;font-weight:800;cursor:pointer}
body.dark-theme  .btn-ok{background:#0a84ff;color:#fff}
body.light-theme .btn-ok{background:#007aff;color:#fff}

/* Bottom nav */
.bottom-nav{position:fixed;left:0;right:0;bottom:0;width:100%;max-width:500px;margin:0 auto;display:flex;justify-content:space-around;align-items:center;gap:8px;padding:6px 8px calc(env(safe-area-inset-bottom,0) + 6px);border-top:1px solid;z-index:1000;backdrop-filter:saturate(180%) blur(8px)}
.light-theme .bottom-nav{background:rgba(255,255,255,0.92);border-top-color:#e0e0e0}
.dark-theme .bottom-nav{background:rgba(28,28,30,0.92);border-top-color:#38383a}
.nav-btn{flex:1;min-width:0;max-width:120px;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:2px;padding:8px 6px;border:none;background:transparent;border-radius:12px;cursor:pointer;font-family:var(--font-family);font-size:.75rem;line-height:1.1;transition:transform .08s ease, background-color .15s ease, color .15s ease}
.nav-btn i{font-size:1.2rem;line-height:1}
.light-theme .nav-btn{color:#6d6d72}
.dark-theme  .nav-btn{color:#8e8e93}
.nav-btn:active{transform:scale(.96)}
.nav-btn.active{font-weight:700}
.light-theme .nav-btn.active{color:#007aff;background:rgba(0,122,255,.12)}
.dark-theme .nav-btn.active{color:#0a84ff;background:rgba(10,132,255,.14)}

/* Withdraw */
#withdraw-page .form-group{margin-bottom:14px}
#withdraw-form label{display:block;margin-bottom:6px;font-size:.9rem;font-weight:700}
#withdraw-form input,#withdraw-form select{width:100%;padding:12px 14px;border-radius:8px;font-size:1rem;font-family:var(--font-family);outline:none;transition:.15s;border:1px solid;appearance:none}
body.light-theme #withdraw-form input,body.light-theme #withdraw-form select{background:#f4f4f9;border-color:#e0e0e0;color:#1c1c1e}
body.light-theme #withdraw-form input:focus,body.light-theme #withdraw-form select:focus{border-color:#007aff;box-shadow:0 0 0 3px rgba(0,122,255,.15)}
body.dark-theme #withdraw-form input,body.dark-theme #withdraw-form select{background:#1c1c1e;border-color:#38383a;color:#fff}
body.dark-theme #withdraw-form input:focus,body.dark-theme #withdraw-form select:focus{border-color:#0a84ff;box-shadow:0 0 0 3px rgba(10,132,255,.18)}
#withdraw-form input::placeholder{opacity:.7}
#withdraw-submit-btn{margin-top:8px;width:100%}

/* ===== Bonus Checking Modal (premium) ===== */
.check-modal{position:fixed;inset:0;display:none;place-items:center;background:rgba(0,0,0,.55);z-index:3500}
.check-modal.show{display:grid}
.check-card{
  width:min(420px,calc(100% - 40px));
  border-radius:18px;padding:22px;border:1px solid;
  text-align:center;box-shadow:0 20px 60px rgba(0,0,0,.45)
}
body.dark-theme .check-card{background:#1c1c1e;border-color:#38383a;color:#fff}
body.light-theme .check-card{background:#fff;border-color:#e0e0e0;color:#1c1c1e}
.check-ring{width:64px;height:64px;margin:0 auto 14px;position:relative}
.check-ring:before,.check-ring:after{
  content:"";position:absolute;inset:0;border-radius:50%;border:4px solid transparent;
  border-top-color:currentColor;animation:spin 1s linear infinite
}
.check-ring:after{inset:6px;border-width:4px;border-bottom-color:currentColor;animation-duration:1.4s;opacity:.7}
.check-title{font-weight:800;font-size:1.05rem;margin-bottom:6px}
.check-sub{font-size:.92rem;opacity:.85}
.check-ok{display:none;margin-top:8px;font-weight:800}
.check-modal.success .check-ok{display:block}
  </style>
<link rel="me" href="https://www.blogger.com/profile/15347509879487217923" />
<meta name='google-adsense-platform-account' content='ca-host-pub-1556223355139109'/>
<meta name='google-adsense-platform-domain' content='blogspot.com'/>
</head>
<body>
  <!-- Premium boot overlay -->
  <div id="boot-overlay" aria-hidden="true">
    <div class="boot-card">
      <div class="boot-logo"><i class="fa-solid fa-bolt"></i></div>
      <div class="boot-title">Loading your dashboard…</div>
      <div class="boot-sub">Securely syncing profile & config</div>
      <div class="boot-progress"><div class="boot-bar"></div></div>
      <div class="boot-hint">Please wait a moment</div>
    </div>
  </div>

  <div id="app" style="visibility:hidden">
    <!-- Header with skeleton -->
    <header class="profile-header">
      <div class="profile-info">
        <div id="skel-avatar" class="skel skel-avatar"></div>
        <img id="user-photo" src="" alt="User Photo" style="display:none"/>
        <div class="user-details">
          <div id="skel-name" class="skel skel-line w80" style="margin:6px 0 8px"></div>
          <h1 id="user-name" style="display:none">Loading… <i class="fas fa-check-circle verified-icon"></i></h1>
          <div id="skel-balance" class="skel skel-line w60"></div>
          <p id="balance-line" style="display:none">ব্যালেন্স: <span id="user-balance">0</span> টাকা 💰</p>
        </div>
      </div>
      <div id="mini-app-pill" class="mini-app-badge"><i class="fa-solid fa-hand-peace"></i> <span id="mini-app-text">ওয়েলকাম</span></div>
    </header>

    <main id="main-content">
      <!-- Home -->
      <div id="home-page" class="page active">
        <h2>Dashboard</h2>

        <!-- skeleton cards -->
        <div id="skel-stats" class="stats-grid">
          <div class="stat-card"><div class="skel skel-line w60" style="height:16px;margin:0 auto 10px"></div><div class="skel" style="height:26px;border-radius:8px"></div></div>
          <div class="stat-card"><div class="skel skel-line w60" style="height:16px;margin:0 auto 10px"></div><div class="skel" style="height:26px;border-radius:8px"></div></div>
        </div>

        <div id="stats-real" class="stats-grid" style="display:none">
          <div class="stat-card">
            <h3>Daily Ads Watched</h3>
            <p><span id="daily-ads-watched">0</span> / <span id="daily-ads-limit">10</span></p>
          </div>
          <div class="stat-card">
            <h3>Total Referrals</h3>
            <p id="referral-count">0</p>
          </div>
        </div>

        <div class="referral-section" id="ref-section" style="visibility:hidden">
          <h3>Refer & Earn More!</h3>
          <p class="ref-text">
            রেফার বোনাস পেতে লিংকটি কপি করে আপনার বন্ধুদের কাছে শেয়ার করুন। প্রতি রেফারে আয় <b><span id="ref-bonus-label">30</span></b> টাকা.
          </p>
          <input type="text" id="referral-link" readonly />
          <div class="ref-btns">
            <button id="copy-ref-link-btn">Copy Referral Link</button>
            <button id="share-on-telegram-btn" class="share-btn">
              <i class="fas fa-share-alt"></i> Share Now
            </button>
          </div>
          <small id="referral-hint" style="display:block;margin-top:6px;opacity:.75;"></small>
        </div>
      </div>

      <!-- Support -->
      <div id="support-page" class="page">
        <h2>Support</h2>
        <div class="task-container">
          <i class="fas fa-circle-play task-icon"></i>
          <h3>Tutorial Video</h3>
          <p>কিভাবে অ্যাপটি ব্যবহার করবেন—টিউটোরিয়াল দেখে নিন।</p>
          <button id="open-tutorial-btn" class="action-btn">
            <span class="btn-text">Open Tutorial</span>
            <span class="btn-loader"></span>
          </button>
          <small style="display:block;margin-top:6px;opacity:.8;">🎞️ <b>ভিডিও দেখে</b> সব কিছু বুঝে নিন </small>
        </div>
      </div>

      <!-- Tasks -->
      <div id="tasks-page" class="page">
        <h2>Complete Tasks</h2>

        <div class="task-container">
          <i class="fas fa-video task-icon"></i>
          <h3>Rewarded Ad</h3>
          <p id="ad-reward-line">প্রতিটি বিজ্ঞাপনের জন্য <b id="ad-reward-label">5</b> টাকা আয় করুন।</p>
          <p id="ad-verify-hint">অ্যাড দেখে আয় করতে ভেরিফাই করুন!</p>
          <button id="watch-ad-btn" class="action-btn">
            <span class="btn-text">Verify (/start)</span>
            <span class="btn-loader"></span>
          </button>
          <p id="ad-timer-note">পুরস্কার পেতে 15 সেকেন্ডের জন্য বিজ্ঞাপনে থাকুন।</p>
        </div>

        <div class="task-container">
          <i class="fab fa-telegram task-icon"></i>
          <h3>Join our Telegram Channel</h3>
          <p>চ্যানেলে জয়েন করুন, তারপর ফিরে এসে "Check & Claim" দিন।</p>
          <div style="display:flex;gap:10px">
            <button id="open-channel-btn" class="action-btn"><span class="btn-text">Open Channel</span></button>
            <button id="check-channel-btn" class="action-btn"><span class="btn-text">Check & Claim</span></button>
          </div>
          <p id="channel-bonus-note" style="margin-top:10px;font-size:.85rem;opacity:.8;"></p>
          <small id="channel-claimed-note" style="display:block;margin-top:6px;opacity:.8;"></small>
        </div>

        <div class="task-container">
          <i class="fab fa-youtube task-icon"></i>
          <h3>Subscribe our YouTube</h3>
          <p>Open YouTube এ ক্লিক করুন, সাবস্ক্রাইব করুন, তারপর "Check & Claim" দিন।</p>
          <div style="display:flex;gap:10px">
            <button id="open-youtube-btn" class="action-btn"><span class="btn-text">Open YouTube</span></button>
            <button id="claim-youtube-btn" class="action-btn"><span class="btn-text">Check & Claim</span></button>
          </div>
          <p id="youtube-bonus-note" style="margin-top:10px;font-size:.85rem;opacity:.8;"></p>
          <small id="youtube-claimed-note" style="display:block;margin-top:6px;opacity:.8;"></small>
        </div>
      </div>

      <!-- Withdraw -->
      <div id="withdraw-page" class="page">
        <h2>Withdraw (টাকা)</h2>
        <p>ন্যূনতম <b id="min-withdraw-label">1500</b> টাকা এবং কমপক্ষে <b id="req-ref-label">20</b> টি রেফারেল প্রয়োজন। </p>
        <form id="withdraw-form">
          <div class="form-group">
            <label for="withdraw-method">Method:</label>
            <select id="withdraw-method" required>
              <option value="Bkash">Bkash</option>
              <option value="Nagad">Nagad</option>
            </select>
          </div>
          <div class="form-group">
            <label for="account-number">Account Number:</label>
            <input type="text" id="account-number" placeholder="01XXXXXXXXX" required />
          </div>
          <div class="form-group">
            <label for="amount">Amount (টাকা):</label>
            <input type="number" id="amount" placeholder="1500" required />
          </div>
          <button type="submit" id="withdraw-submit-btn" class="action-btn">
            <span class="btn-text">Submit Request</span><span class="btn-loader"></span>
          </button>
        </form>
      </div>
    </main>

    <nav class="bottom-nav">
      <button class="nav-btn active" data-page="home-page"><i class="fas fa-home"></i><span>Home</span></button>
      <button class="nav-btn" data-page="support-page"><i class="fas fa-headset"></i><span>Support</span></button>
      <button class="nav-btn" data-page="tasks-page"><i class="fas fa-tasks"></i><span>Tasks</span></button>
      <button class="nav-btn" data-page="withdraw-page"><i class="fas fa-wallet"></i><span>Withdraw</span></button>
    </nav>
  </div>

  <!-- Small in-ad modal -->
  <div id="loading-modal" class="modal">
    <div class="modal-content">
      <div class="loader"></div>
      <p id="loading-text">Loading Ad...</p>
      <p id="countdown-text" style="margin-top:8px;font-weight:600;"></p>
    </div>
  </div>

  <!-- News popup -->
  <div id="newsOverlay" class="news-overlay"></div>
  <div id="newsModal" class="news-modal" role="dialog" aria-modal="true" aria-labelledby="newsTitle">
    <div class="news-hero">
      <button type="button" class="news-close" aria-label="Close">✕</button>
      <h3 id="newsTitle">স্বাগতম!</h3>
      <div class="news-emoji">🔥</div>
    </div>
    <div class="news-body" id="newsBody"></div>
    <div class="news-foot"><button type="button" class="btn-ok" id="newsOkBtn">বুঝেছি</button></div>
  </div>

  <!-- Bonus Checking Modal (premium) -->
  <div id="bonus-check-modal" class="check-modal" role="dialog" aria-modal="true" aria-labelledby="bonusCheckTitle">
    <div class="check-card">
      <div class="check-ring"></div>
      <div class="check-title" id="bonusCheckTitle">Checking…</div>
      <div class="check-sub" id="bonusCheckSub">Please wait while we verify your bonus.</div>
      <div class="check-ok" id="bonusCheckOk">Verified ✅</div>
    </div>
  </div>

  <!-- Telegram SDK -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <!-- Monetag SDK (keep static) -->
  <script src='//libtl.com/sdk.js' data-zone='9707941' data-sdk='show_9707941'></script>
  <!-- (Removed static GigaPub tag; scripts will be loaded dynamically from CONFIG) -->

  <script>
  document.addEventListener('DOMContentLoaded', () => {
    const tg = window.Telegram.WebApp;

    /* ========= BASE ========= */
    const API_BASE   = "https://jobsguru120.top/mini_app/red_chilii_bot";

    /* Try app_config.php first; fallback to config_api.php */
    const CONFIG_URLS = [
      "https://jobsguru120.top/mini_app/red_chilii_bot/app_config.php",
      "https://jobsguru120.top/mini_app/red_chilii_bot/config_api.php"
    ];

    /* ======= CONFIG (defaults) ======= */
    let CONFIG = {
      botUsername:"", channelId:null, channelUsername:"",
      youtubeSubscribeUrl:"", youtubeTutorialUrl:"",
      adRewardTk:0, channelBonusTk:0, youtubeBonusTk:0,
      referrerBonusTk:0, defaultDailyLimit:10,
      minWithdrawTk:0, requiredReferrals:0,
      withdrawGroupId:null, withdrawCooldownHours:0, maxWithdrawTk:null,
      newsText:"", newsIntervalMinutes:0,

      /* Ads master + per-network flags */
      adsEnabled:true,
      monetagEnabled:false,
      gigapubEnabled:true,
      doubleAdMode:true,
      allowAdFallback:true,

      /* Watch-time gating (new) */
      enforceWatchSeconds:true,  // true = must watch N seconds
      watchSeconds:10,           // N seconds (UI shows this)

      /* GigaPub script URLs (ordered, round-robin) */
      gigapubScripts:[
        // "https://ad.gigapub.tech/script?id=2607",
        // "=",
      ]
    };

    /* ========= DOM ========= */
    const bootOverlay = document.getElementById('boot-overlay');
    const appRoot     = document.getElementById('app');

    const userPhotoElem = document.getElementById('user-photo');
    const userNameElem  = document.getElementById('user-name');
    const balLine       = document.getElementById('balance-line');
    const skelAvatar    = document.getElementById('skel-avatar');
    const skelName      = document.getElementById('skel-name');
    const skelBalance   = document.getElementById('skel-balance');

    const skelStats  = document.getElementById('skel-stats');
    const statsReal  = document.getElementById('stats-real');
    const refSection = document.getElementById('ref-section');

    const userBalanceElem     = document.getElementById('user-balance');
    const dailyAdsWatchedElem = document.getElementById('daily-ads-watched');
    const dailyAdsLimitElem   = document.getElementById('daily-ads-limit');
    const referralCountElem   = document.getElementById('referral-count');
    const referralLinkElem    = document.getElementById('referral-link');
    const referralHint        = document.getElementById('referral-hint');
    const copyRefLinkBtn      = document.getElementById('copy-ref-link-btn');
    const shareOnTelegramBtn  = document.getElementById('share-on-telegram-btn');
    const refBonusLabel       = document.getElementById('ref-bonus-label');

    const watchAdBtn       = document.getElementById('watch-ad-btn');
    const openChannelBtn   = document.getElementById('open-channel-btn');
    const checkChannelBtn  = document.getElementById('check-channel-btn');
    const openYoutubeBtn   = document.getElementById('open-youtube-btn');
    const claimYoutubeBtn  = document.getElementById('claim-youtube-btn');

    const channelClaimNote = document.getElementById('channel-claimed-note');
    const youtubeClaimNote = document.getElementById('youtube-claimed-note');
    const channelBonusNote = document.getElementById('channel-bonus-note');
    const youtubeBonusNote = document.getElementById('youtube-bonus-note');

    const withdrawForm      = document.getElementById('withdraw-form');
    const withdrawSubmitBtn = document.getElementById('withdraw-submit-btn');

    const loadingModal  = document.getElementById('loading-modal');
    const loadingText   = document.getElementById('loading-text');
    const countdownText = document.getElementById('countdown-text');

    const newsOverlay = document.getElementById('newsOverlay');
    const newsModal   = document.getElementById('newsModal');
    const newsBodyEl  = document.getElementById('newsBody');
    const newsOkBtn   = document.getElementById('newsOkBtn');

    const welcomePill = document.getElementById('mini-app-pill');

    // ===== Bonus Checking Modal refs =====
    const bonusCheckModal = document.getElementById('bonus-check-modal');
    const bonusCheckTitle = document.getElementById('bonusCheckTitle');
    const bonusCheckSub   = document.getElementById('bonusCheckSub');
    const bonusCheckOk    = document.getElementById('bonusCheckOk');

    function showBonusChecking(title, sub){
      bonusCheckModal.classList.remove('success');
      bonusCheckTitle.textContent = title || 'Checking…';
      bonusCheckSub.textContent   = sub   || 'Please wait while we verify your bonus.';
      bonusCheckModal.style.display = 'grid';
    }
    function finishBonusChecking(okText){
      bonusCheckOk.textContent = okText || 'Verified ✅';
      bonusCheckModal.classList.add('success');
      setTimeout(hideBonusChecking, 900);
    }
    function hideBonusChecking(){
      bonusCheckModal.style.display = 'none';
      bonusCheckModal.classList.remove('success');
    }

    /* ========= STATE ========= */
    let userState = {
      userId:null, balanceTK:0, referralCount:0, refBy:null,
      dailyAdLimit:0, watchedToday:0, telegramBonus:0, youtubeBonus:0,
      isBotVerified:0
    };
    const saveState = ()=>{ if(userState.userId) localStorage.setItem(`userState_${userState.userId}`, JSON.stringify(userState)); }
    const loadState = (uid)=>{ const s=localStorage.getItem(`userState_${uid}`); if(s) userState = {...userState, ...JSON.parse(s)} }

    /* === Per-user next ad provider toggle (round-robin: Monetag ⇄ GigaPub) === */
    const nextProvKey = (uid)=>`ad_next_provider_${uid}`;
    function getNextProvider(){
      const uid = userState.userId;
      let p = (uid && localStorage.getItem(nextProvKey(uid))) || 'monetag';

      const monOK  = !!CONFIG.monetagEnabled;
      const gigaOK = !!CONFIG.gigapubEnabled;

      if(!CONFIG.adsEnabled || (!monOK && !gigaOK)) return null;

      if(p==='monetag' && monOK) return 'monetag';
      if(p==='monetag' && !monOK && gigaOK) return 'gigapub';
      if(p==='gigapub' && gigaOK) return 'gigapub';
      if(p==='gigapub' && !gigaOK && monOK) return 'monetag';

      return monOK ? 'monetag' : (gigaOK ? 'gigapub' : null);
    }
    function flipNextProvider(used){
      const uid = userState.userId;
      if(!uid) return;
      const next = used==='monetag' ? 'gigapub' : 'monetag';
      localStorage.setItem(nextProvKey(uid), next);
    }

    /* ========= HELPERS ========= */
    const CONFIG_CACHE_KEY = "APP_CONFIG_CACHE_v2";
    const sleep = (ms)=> new Promise(r=>setTimeout(r,ms));

    function mergeConfig(dst, src){ for(const [k,v] of Object.entries(src||{})){ if(v!==""&&v!==null&&typeof v!=="undefined") dst[k]=v; } return dst; }

    function toBool(v){
      if (typeof v === 'boolean') return v;
      if (typeof v === 'number')  return v !== 0;
      if (typeof v === 'string')  return ['1','true','yes','on'].includes(v.trim().toLowerCase());
      return false;
    }
    function toInt(v, def=0){
      const n = parseInt(v, 10);
      return Number.isFinite(n) ? n : def;
    }
    function normalizeConfig(){
      CONFIG.adsEnabled        = toBool(CONFIG.adsEnabled);
      CONFIG.monetagEnabled    = toBool(CONFIG.monetagEnabled);
      CONFIG.gigapubEnabled    = toBool(CONFIG.gigapubEnabled);
      CONFIG.doubleAdMode      = toBool(CONFIG.doubleAdMode);
      CONFIG.allowAdFallback   = toBool(CONFIG.allowAdFallback);
      CONFIG.enforceWatchSeconds = toBool(CONFIG.enforceWatchSeconds);
      CONFIG.watchSeconds      = toInt(CONFIG.watchSeconds, 10);

      CONFIG.adRewardTk        = toInt(CONFIG.adRewardTk, 0);
      CONFIG.channelBonusTk    = toInt(CONFIG.channelBonusTk, 0);
      CONFIG.youtubeBonusTk    = toInt(CONFIG.youtubeBonusTk, 0);
      CONFIG.defaultDailyLimit = toInt(CONFIG.defaultDailyLimit, 10);
      CONFIG.minWithdrawTk     = toInt(CONFIG.minWithdrawTk, 0);
      CONFIG.requiredReferrals = toInt(CONFIG.requiredReferrals, 0);
      CONFIG.maxWithdrawTk     = toInt(CONFIG.maxWithdrawTk||0, 0);
      CONFIG.newsIntervalMinutes = toInt(CONFIG.newsIntervalMinutes||0, 0);

      if (!Array.isArray(CONFIG.gigapubScripts)) CONFIG.gigapubScripts = [];
      CONFIG.gigapubScripts = CONFIG.gigapubScripts.filter(u => typeof u === 'string' && u.trim().length>0);
    }

    function buildRefLink(botUsername, userId){
      if(!botUsername || !userId) return '';
      return `https://t.me/${botUsername}/app?startapp=${userId}`;
    }

    async function fetchJSON(url, opts={}, retries=1){
      try{
        const res = await fetch(url, opts);
        if(!res.ok) throw new Error("HTTP "+res.status);
        return await res.json();
      }catch(e){
        if(retries>0){ await sleep(400); return fetchJSON(url, opts, retries-1); }
        throw e;
      }
    }

    async function loadConfig(){
      try{
        const cached = JSON.parse(localStorage.getItem(CONFIG_CACHE_KEY)||"null");
        const now = Date.now();
        let j = null;

        // fresh fetch (try app_config.php then config_api.php)
        for(const url of CONFIG_URLS){
          try{
            const tryRes = await fetch(`${url}?nocache=${now}`, {cache:'no-store'});
            if(tryRes.ok){
              j = await tryRes.json();
              break;
            }
          }catch(_){}
        }

        if(j && j.ok===true){
          CONFIG = mergeConfig(CONFIG, j);
          localStorage.setItem(CONFIG_CACHE_KEY, JSON.stringify({ts:now,data:j}));
        }else if(cached && cached.data){
          CONFIG = mergeConfig(CONFIG, cached.data);
        }
      }catch(e){
        try{tg.showAlert("⚠️ Config লোড হয়নি। ডিফল্ট দিয়ে চলবে।");}catch(_){}
      }

      normalizeConfig(); // <-- important

      // reflect static labels early
      document.getElementById('ad-reward-label').textContent    = String(CONFIG.adRewardTk);
      document.getElementById('min-withdraw-label').textContent = String(CONFIG.minWithdrawTk);
      document.getElementById('req-ref-label').textContent      = String(CONFIG.requiredReferrals);
      if(refBonusLabel) refBonusLabel.textContent               = String(CONFIG.referrerBonusTk);
      channelBonusNote.textContent = `চ্যানেলে জয়েন করলে +${CONFIG.channelBonusTk} টাকা পাবেন।`;
      youtubeBonusNote.textContent = `YouTube সাবস্ক্রাইব করলে +${CONFIG.youtubeBonusTk} টাকা পাবেন।`;

      // Show/hide countdown note text per config
      document.getElementById('ad-timer-note').style.display = CONFIG.enforceWatchSeconds ? 'block' : 'none';
    }

    async function api(payload){
      return fetchJSON(`${API_BASE}/register.php`, {
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify(payload||{})
      });
    }

    async function registerAndSyncProfile(){
      const u = tg.initDataUnsafe?.user;
      if(!u?.id) return;
      const sp = tg.initDataUnsafe?.start_param || "";
      let refBy = 0;
      if(/^\d+$/.test(sp)) refBy = parseInt(sp,10);
      else{ const m = String(sp).match(/^ref_(\d+)$/); if(m) refBy = parseInt(m[1],10); }
      if(refBy === u.id) refBy = 0;

      const payload = {
        action:"register", userId:u.id,
        firstName:u.first_name||"", lastName:u.last_name||"",
        username:u.username||"", photoUrl:u.photo_url||""
      };
      if(refBy>0) payload.refBy = refBy; else if(sp) payload.startParam = sp;

      const data = await api(payload);

      userState.userId        = u.id;
      userState.balanceTK     = parseInt(data.points||0,10);
      userState.referralCount = parseInt(data.referralCount||0,10);
      userState.refBy         = data.refBy || null;
      userState.dailyAdLimit  = parseInt(data.dailyAdLimit ?? CONFIG.defaultDailyLimit, 10);
      userState.watchedToday  = parseInt(data.watchedToday ?? 0, 10);
      userState.telegramBonus = parseInt(data.telegramBonus ?? 0, 10);
      userState.youtubeBonus  = parseInt(data.youtubeBonus ?? 0, 10);

      saveState();
    }

    // UI switch between skeleton and real
    function revealUI(){
      skelAvatar.style.display = 'none';
      skelName.style.display   = 'none';
      skelBalance.style.display= 'none';
      userPhotoElem.style.display = 'block';
      userNameElem.style.display  = 'block';
      balLine.style.display       = 'block';
      skelStats.style.display = 'none';
      statsReal.style.display = 'grid';
      refSection.style.visibility = 'visible';
      appRoot.style.visibility = 'visible';
      bootOverlay.style.display = 'none';
    }

    /* ========= SCRIPT LOADER for GigaPub ========= */
    function loadScriptOnce(url, timeoutMs=10000){
      return new Promise((resolve, reject)=>{
        const existing = Array.from(document.scripts).find(s => s.src === url);
        if(existing && existing.dataset.loaded === '1'){ resolve(); return; }

        const s = document.createElement('script');
        s.src = url;
        s.async = true;
        s.dataset.intent = 'gigapub';
        let done = false;
        const timer = setTimeout(()=>{ if(done) return; done=true; s.remove(); reject(new Error('Script load timeout')); }, timeoutMs);
        s.onload = ()=>{ if(done) return; done=true; clearTimeout(timer); s.dataset.loaded='1'; resolve(); };
        s.onerror= ()=>{ if(done) return; done=true; clearTimeout(timer); s.remove(); reject(new Error('Script load error')); };
        document.head.appendChild(s);
      });
    }
    const gpIndexKey = (uid)=>`gigapub_index_${uid}`;
    function nextGigapubScript(){
      const arr = Array.isArray(CONFIG.gigapubScripts) ? CONFIG.gigapubScripts : [];
      if(arr.length===0) return null;
      const uid = userState.userId || 'anon';
      const cur = parseInt(localStorage.getItem(gpIndexKey(uid))||'0',10) || 0;
      const url = arr[cur % arr.length];
      localStorage.setItem(gpIndexKey(uid), String((cur+1) % Math.max(1,arr.length)));
      return url;
    }
    async function ensureGigaReady(){
      const url = nextGigapubScript();
      if(!url) throw new Error('No GigaPub scripts configured');
      await loadScriptOnce(url, 10000);
      if(typeof window.showGiga !== 'function') throw new Error('GigaPub show function not found');
    }

    /* ====== AD HELPERS (Monetag & GigaPub) ====== */
    async function showMonetagOnce(){
      if(typeof window.show_9707941 !== 'function') throw new Error('Monetag SDK not ready');
      await window.show_9707941();
    }
    async function showGigaOnce(){
      await ensureGigaReady();
      await window.showGiga();
    }

    // Run provider for "needed" impressions; return how many actually shown
    async function runProvider(provider, needed){
      let shown = 0;
      for (let i = 0; i < needed; i++) {
        try{
          if(provider === 'monetag')      await showMonetagOnce();
          else if(provider === 'gigapub') await showGigaOnce();
          else throw new Error('Unknown provider');
          shown++;
        }catch(e){
          break; // stop this provider; caller may fallback remaining
        }
      }
      return shown;
    }

    // ===== COUNTDOWN control =====
    function startCountdownIfNeeded(){
      // returns {stop, passed}, where passed() tells if watchSeconds satisfied
      const ENF = CONFIG.enforceWatchSeconds;
      const REQ = CONFIG.watchSeconds;
      let startTs = Date.now();
      let timer = null;

      loadingText.textContent = ENF ? "Loading Ad..." : "Loading Ad…";
      countdownText.textContent = "";
      loadingModal.style.display='flex';

      if(ENF){
        let secLeft = REQ;
        const tick = ()=>{ countdownText.textContent = secLeft>0 ? `Please wait ${secLeft}s...` : ""; };
        tick();
        timer = setInterval(()=>{ secLeft--; tick(); if(secLeft<=0){ clearInterval(timer); timer=null; } }, 1000);
      }else{
        countdownText.textContent = ""; // no UI countdown
      }

      return {
        stop: ()=>{ if(timer) clearInterval(timer); loadingModal.style.display='none'; },
        passed: ()=> !ENF || ((Date.now() - startTs)/1000 >= REQ)
      };
    }

    // ===== Core ad flow with strict sequencing & exact impression cap =====
    let _watchBusy = false;

    async function handleWatchAd(){
      if (_watchBusy) return;
      _watchBusy = true;

      try{
        if (userState.watchedToday >= userState.dailyAdLimit) { tg.showAlert("আজকের লিমিট পূরণ হয়েছে।"); return; }
        if (!CONFIG.adsEnabled || (!CONFIG.monetagEnabled && !CONFIG.gigapubEnabled)) {
          tg.showAlert("এই মুহূর্তে বিজ্ঞাপন বন্ধ রয়েছে।"); return;
        }

        const needed = CONFIG.doubleAdMode ? 2 : 1;
        let provider = getNextProvider();
        if(!provider){ tg.showAlert("এই মুহূর্তে কোনো বিজ্ঞাপন উপলব্ধ নেই।"); return; }

        // Countdown / modal handling
        const gate = startCountdownIfNeeded();

        // 1) Try primary
        let shown = await runProvider(provider, needed);
        let usedLast = provider;

        // 2) If partial and fallback allowed, top-up only remaining with backup
        if (shown < needed && CONFIG.allowAdFallback){
          const backup   = provider === 'monetag' ? 'gigapub' : 'monetag';
          const backupOK = (backup==='monetag' && CONFIG.monetagEnabled) || (backup==='gigapub' && CONFIG.gigapubEnabled);
          if (backupOK){
            const remaining = needed - shown;
            const add = await runProvider(backup, remaining);
            shown += add;
            if(add > 0) usedLast = backup;
          }
        }

        // ensure exact cap
        if (shown !== needed){
          gate.stop();
          tg.showAlert("Ad failed. Try later.");
          return;
        }

        // Enforce watch seconds if enabled
        if (!gate.passed()){
          gate.stop();
          tg.showAlert(`${CONFIG.watchSeconds} সেকেন্ড পূর্ণ হয়নি।`);
          return;
        }

        // Flip for next click based on the provider that actually finished last
        flipNextProvider(usedLast);

        // CLAIM once
        const res=await fetch(`${API_BASE}/claim_ad.php`,{
          method:"POST",
          headers:{"Content-Type":"application/json"},
          body:JSON.stringify({userId:userState.userId, amount:CONFIG.adRewardTk, provider:usedLast})
        });
        const resp=await res.json();
        gate.stop();
        if(!resp.ok){ tg.showAlert(resp.message||"Claim failed."); return; }

        await registerAndSyncProfile();
        updateUI();
        tg.HapticFeedback?.notificationOccurred?.('success');
        tg.showAlert(`বিজ্ঞাপন দেখা সফল হয়েছে। আপনি ${CONFIG.adRewardTk} টাকা এড বোনাস পেয়েছেন ✅`);

      }catch(e){
        try{ loadingModal.style.display='none'; }catch(_){}
        tg.showAlert("Ad/Claim failed. Try later.");
      }finally{
        _watchBusy = false;
      }
    }

    // ===== Channel verification — with premium checking modal =====
    async function checkChannelAndClaim(){
  if (userState.telegramBonus === 1) return; // একবার ক্লেইম হলে আর alert নয়

  const btn = checkChannelBtn;
  const oldTxt = btn.querySelector('.btn-text').textContent;
  try {
    btn.disabled = true;
    btn.querySelector('.btn-text').textContent = 'Checking…';
    showBonusChecking('Checking Telegram Join…', 'Verifying your membership in our channel.');

    const resp = await api({
      action: "check_channel",
      userId: userState.userId,
      channel_id: CONFIG.channelId,
      bonus: CONFIG.channelBonusTk
    });

    if (resp.ok && resp.joined && resp.claimed) {
      userState.telegramBonus = 1;
      finishBonusChecking(`+${CONFIG.channelBonusTk} TK added 🎉`);
      registerAndSyncProfile().then(() => { updateUI(); });
      tg.HapticFeedback?.notificationOccurred?.('success');
      // ✅ সফল ক্লেইম হলে শুধু এই alert
      tg.showAlert(`চ্যানেল জয়েন বোনাস পেয়েছেন ${CONFIG.channelBonusTk} টাকা ✅`);
    }

    updateUI();
  } catch (e) {
    hideBonusChecking();
    // ❌ error কেসে আর alert নয় (তুমি চাইছো শুধু success alert থাকুক)
  } finally {
    btn.disabled = false;
    btn.querySelector('.btn-text').textContent = oldTxt;
  }
}

    // ===== YouTube claim — with premium checking modal =====
    async function claimYouTubeOnce(){
  if (userState.youtubeBonus === 1) return; // একবার ক্লেইম হলে আর alert নয়

  const btn = claimYoutubeBtn;
  const oldTxt = btn.querySelector('.btn-text').textContent;
  try {
    btn.disabled = true;
    btn.querySelector('.btn-text').textContent = 'Checking…';
    showBonusChecking('Checking YouTube Subscribe…', 'Verifying your subscription.');

    const resp = await api({
      action: "claim_youtube",
      userId: userState.userId,
      bonus: CONFIG.youtubeBonusTk
    });

    if (resp.ok && resp.claimed) {
      userState.youtubeBonus = 1;
      finishBonusChecking(`+${CONFIG.youtubeBonusTk} TK added 🎉`);
      registerAndSyncProfile().then(() => { updateUI(); });
      tg.HapticFeedback?.notificationOccurred?.('success');
      // ✅ শুধু successful claim হলে alert
      tg.showAlert(`সাবস্ক্রাইব বোনাস পেয়েছেন ${CONFIG.youtubeBonusTk} টাকা ✅`);
    }

    updateUI();
  } catch {
    hideBonusChecking();
    // ❌ error হলে কোনো alert নয়
  } finally {
    btn.disabled = false;
    btn.querySelector('.btn-text').textContent = oldTxt;
  }
}

    // UI helpers
    function setButtonToVerifyMode(){
      watchAdBtn.classList.remove('loading'); watchAdBtn.disabled=false; watchAdBtn.dataset.mode='verify';
      watchAdBtn.querySelector('.btn-text').textContent='Verify ☑';
      document.getElementById('ad-verify-hint').style.display='block';
      document.getElementById('ad-reward-line').style.display='none';
      document.getElementById('ad-timer-note').style.display = CONFIG.enforceWatchSeconds ? 'block' : 'none';
    }
    function setButtonToWatchMode(){
      watchAdBtn.classList.remove('loading'); watchAdBtn.disabled=false; watchAdBtn.dataset.mode='watch';
      watchAdBtn.querySelector('.btn-text').textContent='Watch Ad';
      document.getElementById('ad-verify-hint').style.display='none';
      document.getElementById('ad-reward-line').style.display='block';
      document.getElementById('ad-timer-note').style.display = CONFIG.enforceWatchSeconds ? 'block' : 'none';
    }

    function updateUI(){
      const u = tg.initDataUnsafe?.user;
      if(u){ userPhotoElem.src = u.photo_url || 'https://i.imgur.com/placeholder.png'; userNameElem.innerHTML = `${u.first_name||''} ${u.last_name||''} <i class="fas fa-check-circle verified-icon"></i>`; }

      userBalanceElem.textContent     = String(userState.balanceTK||0);
      dailyAdsWatchedElem.textContent = String(userState.watchedToday||0);
      dailyAdsLimitElem.textContent   = String(userState.dailyAdLimit||0);
      referralCountElem.textContent   = String(userState.referralCount||0);

      if(CONFIG.botUsername && CONFIG.botUsername.trim()){
        referralLinkElem.value = buildRefLink(CONFIG.botUsername.trim(), userState.userId);
        referralHint.textContent = ""; copyRefLinkBtn.disabled=false; shareOnTelegramBtn.disabled=false;
      }else{
        referralLinkElem.value="";
        referralHint.textContent="⚠️ রেফারেল লিংক তৈরির জন্য বটের ইউজারনেম কনফিগারে সেট করুন।";
        copyRefLinkBtn.disabled=true; shareOnTelegramBtn.disabled=true;
      }

      document.getElementById('ad-reward-label').textContent    = String(CONFIG.adRewardTk);
      document.getElementById('min-withdraw-label').textContent = String(CONFIG.minWithdrawTk);
      document.getElementById('req-ref-label').textContent      = String(CONFIG.requiredReferrals);
      if(refBonusLabel) refBonusLabel.textContent               = String(CONFIG.referrerBonusTk);

      if(Number(userState.isBotVerified)===1) setButtonToWatchMode(); else setButtonToVerifyMode();

      if(userState.telegramBonus===1){
        checkChannelBtn.disabled=true; channelBonusNote.style.display='none'; channelClaimNote.textContent="✅ Channel bonus claimed";
      }else{
        checkChannelBtn.disabled=false; channelClaimNote.textContent=""; channelBonusNote.style.display='block';
        channelBonusNote.textContent = `চ্যানেলে জয়েন করলে ${CONFIG.channelBonusTk} টাকা পাবেন।`;
      }

      if(userState.youtubeBonus===1){
        claimYoutubeBtn.disabled=true; youtubeBonusNote.style.display='none'; youtubeClaimNote.textContent="✅ YouTube bonus claimed";
      }else{
        claimYoutubeBtn.disabled=false; youtubeClaimNote.textContent=""; youtubeBonusNote.style.display='block';
        youtubeBonusNote.textContent = `YouTube সাবস্ক্রাইব করলে ${CONFIG.youtubeBonusTk} টাকা পাবেন।`;
      }
    }

    function setupNavigation(){
      const navButtons=document.querySelectorAll('.nav-btn'); const pages=document.querySelectorAll('.page');
      navButtons.forEach(btn=>{
        btn.addEventListener('click', ()=>{
          const pageId=btn.dataset.page; pages.forEach(p=>p.classList.remove('active'));
          document.getElementById(pageId).classList.add('active'); navButtons.forEach(b=>b.classList.remove('active')); btn.classList.add('active');
        });
      });
    }

    function setupEventListeners(){
      watchAdBtn.addEventListener('click', async ()=>{
        const mode = watchAdBtn.dataset.mode || 'verify';
        if(mode==='verify'){
          if(watchAdBtn.disabled) return; watchAdBtn.disabled=true;
          openStartLink((CONFIG.botUsername||"").trim(), userState.userId);
          userState.isBotVerified=1; saveState(); updateUI();
          try{ tg.HapticFeedback?.notificationOccurred?.('success'); tg.showAlert("ভেরিফাই সম্পন্ন ✅ এখন আপনি বিজ্ঞাপন দেখতে পারবেন।"); }catch(_){}
          setTimeout(()=>{ watchAdBtn.disabled=false; }, 1500); return;
        }
        await handleWatchAd();
      });

      openChannelBtn.addEventListener('click', ()=>{
        const usernameOrUrl = CONFIG.channelUsername || '';
        if(!usernameOrUrl){ try{tg.showAlert("Channel username not configured.");}catch(_){ } return; }
        const isUrl = String(usernameOrUrl).startsWith('http');
        const username = isUrl ? (usernameOrUrl.split('t.me/')[1]||'').replace(/^\+/, '').split(/[/?#]/)[0] : usernameOrUrl;
        const httpsUrl = isUrl ? usernameOrUrl : `https://t.me/${username}`;
        try{ tg?.openTelegramLink?.(httpsUrl); }catch(_){ window.location.href = httpsUrl; }
      });

      checkChannelBtn.addEventListener('click', checkChannelAndClaim);

      openYoutubeBtn.addEventListener('click', ()=>{
        const YT = (CONFIG.youtubeSubscribeUrl && CONFIG.youtubeSubscribeUrl.trim()) ? CONFIG.youtubeSubscribeUrl.trim() : "https://youtube.com";
        try{ window.open(YT,"_blank"); }catch{ location.href = YT; }
      });
      claimYoutubeBtn.addEventListener('click', claimYouTubeOnce);

      document.getElementById('open-tutorial-btn').addEventListener('click', ()=>{
        const url = (CONFIG.youtubeTutorialUrl && CONFIG.youtubeTutorialUrl.trim()) ? CONFIG.youtubeTutorialUrl.trim() : "";
        if(!url){ try{tg.showAlert("Tutorial URL কনফিগারে সেট করা হয়নি।");}catch(_){ } return; }
        try{ window.open(url,"_blank"); }catch{ location.href=url; }
      });

      copyRefLinkBtn.addEventListener('click', ()=>{
        if(!referralLinkElem.value) return;
        navigator.clipboard.writeText(referralLinkElem.value).then(()=>{
          tg.HapticFeedback?.notificationOccurred?.('success');
          try{tg.showAlert("রেফারেল লিঙ্ক কপি করা হয়েছে! 🤗");}catch(_){}
        });
      });

      shareOnTelegramBtn.addEventListener('click', ()=>{
        const ref=(referralLinkElem.value||'').trim(); if(!ref){ try{tg.showAlert("রেফারেল লিঙ্ক তৈরি হয়নি। একটু পরে চেষ্টা করুন।");}catch(_){ } return; }
        const text=`এই অ্যাপ থেকে বিজ্ঞাপন দেখে টাকা আয় করুন।
১০০% পেমেন্ট করে—আমার লিঙ্কে যোগ দিন:
${ref}`;
        const shareUrl=`https://t.me/share/url?url=${encodeURIComponent(ref)}&text=${encodeURIComponent(text)}`;
        try{ if(tg?.openTelegramLink){ tg.openTelegramLink(shareUrl); return; } }catch(_){}
        if(navigator.share){ navigator.share({title:"Earn with me", text, url:ref}).catch(()=>{}); }
        else{ window.open(shareUrl,"_blank"); }
      });

      withdrawForm.addEventListener('submit', async (e)=>{
        e.preventDefault();
        const method=document.getElementById('withdraw-method').value;
        const accountNumber=document.getElementById('account-number').value.trim();
        const theAmount=document.getElementById('amount').value;
        const amount=parseInt(theAmount,10);
        const MIN_WITHDRAW_TK=CONFIG.minWithdrawTk;
        const REQUIRED_REFERRALS_FOR_WITHDRAW=CONFIG.requiredReferrals;
        if(!accountNumber) return tg.showAlert("Please enter account number/ID.");
        if(isNaN(amount)||amount<=0) return tg.showAlert("Enter a valid amount (TK).");
        const lacksMinAmount=amount<MIN_WITHDRAW_TK;
        const lacksRefs=userState.referralCount<REQUIRED_REFERRALS_FOR_WITHDRAW;
        if(lacksMinAmount||lacksRefs){
          tg.showAlert(`উইথড্র প্রয়োজনীয়তা পূরণ করা হয়নি.🥺
• সর্বনিম্ন ব্যালেন্স: ${MIN_WITHDRAW_TK} টাকা
• ন্যূনতম রেফারেল: ${REQUIRED_REFERRALS_FOR_WITHDRAW}

আপনার একাউন্ট:
• প্রোফাইল ব্যালেন্স: ${userState.balanceTK||0} টাকা
• রেফারেল: ${userState.referralCount}`);
          return;
        }
        if(amount>userState.balanceTK){
          tg.showAlert(`উইথড্র প্রয়োজনীয়তা পূরণ করা হয়নি.🥺
• আপনার ব্যালেন্স: ${userState.balanceTK} টাকা
• রেফারেল: ${userState.referralCount}`);
          return;
        }
        const MAX_WITHDRAW_TK=Number(CONFIG.maxWithdrawTk||0);
        if(MAX_WITHDRAW_TK>0 && amount>MAX_WITHDRAW_TK){ tg.showAlert(`এই মুহূর্তে সর্বোচ্চ ${MAX_WITHDRAW_TK} টাকা পর্যন্ত উইথড্র করা যাবে।`); return; }

        withdrawSubmitBtn.classList.add('loading'); withdrawSubmitBtn.disabled=true;
        const u=tg.initDataUnsafe.user;
        const message =
`<b>New Withdraw Request</b>
<b>User:</b> ${u.first_name||''} ${u.last_name||''} (@${u.username||'N/A'})
<b>ID:</b> <code>${u.id}</code>
<b>Method:</b> ${method}
<b>Account:</b> <code>${accountNumber}</code>
<b>Amount:</b> ${amount} TK
<b>Refs:</b> ${userState.referralCount}
<b>Date:</b> ${new Date().toLocaleString('en-US',{timeZone:'Asia/Dhaka'})}`;

        try{
          const res=await fetch(`${API_BASE}/withdraw.php`,{
            method:"POST",headers:{"Content-Type":"application/json"},
            body:JSON.stringify({userId:u.id,method,accountNumber,amount,refs:userState.referralCount,message,groupId:CONFIG.withdrawGroupId})
          });
          const resp=await res.json();
          if(resp.ok){
            tg.HapticFeedback?.notificationOccurred?.('success');
            tg.showAlert("Withdrawal request submit successfully ✅");
            withdrawForm.reset();
          }else if(resp.error==='cooldown'){
            const secs=parseInt(resp.retry_after_sec||0,10);
            if(secs>0){
              const until=Date.now()+secs*1000; const btn=withdrawSubmitBtn; btn.disabled=true;
              const iv=setInterval(()=>{ const left=Math.max(0,Math.floor((until-Date.now())/1000)); btn.querySelector('.btn-text').textContent=`Wait ${left}s`; if(left<=0){ clearInterval(iv); btn.disabled=false; btn.querySelector('.btn-text').textContent='Submit Request'; } },1000);
              tg.showAlert(`অলরেডি উইথড্র রিকোয়েস্ট দিয়েছেন। ${CONFIG.withdrawCooldownHours} ঘন্টা পূর্ণ হওয়ার আগে নতুন উইথড্র করা যাবে না। 🚫`);
            }else{ tg.showAlert("Cooldown active. Try later."); }
          }else{
            throw new Error(resp.error||"Failed");
          }
        }catch{
          tg.HapticFeedback?.notificationOccurred?.('error');
          tg.showAlert(`আপনি বেশি টাকা লিখেছেন বা অন্য ত্রুটি হয়েছে। সর্বোচ্চ সীমা/শর্ত দেখে আবার চেষ্টা করুন। 🌹`);
        }finally{
          withdrawSubmitBtn.classList.remove('loading'); withdrawSubmitBtn.disabled=false;
        }
      });
    }

    // tiny welcome pill
    function flashWelcomePill(){ try{ welcomePill.style.display='flex'; setTimeout(()=>{ welcomePill.style.display='none'; }, 1800); }catch(_){ } }

    /* ========= BOOT ========= */
    async function initApp(){
      tg.ready(); tg.expand(); document.body.className = `${tg.colorScheme}-theme`;
      const user=tg.initDataUnsafe?.user; if(!user?.id){ tg.showAlert("Open via Telegram."); try{tg.close();}catch(_){ } return; }

      flashWelcomePill();

      userState.userId = user.id; loadState(user.id);
      await Promise.all([ loadConfig(), registerAndSyncProfile() ]);

      updateUI(); appRoot.style.visibility='visible'; revealUI();

      // init default next provider if empty
      if(!localStorage.getItem(nextProvKey(user.id))){
        localStorage.setItem(nextProvKey(user.id), 'monetag');
      }

      setupNavigation(); setupEventListeners();
      await maybeShowNewsFromConfig();
    }

    // Verify flows
    let _startLaunching=false;
    function openStartLink(botUsername, userId){
      if(!botUsername){ try{tg.showAlert("Bot username কনফিগারে নেই।");}catch(_){ } return; }
      if(_startLaunching) return; _startLaunching=true;
      const startParam = `verify_${userId||""}`;
      const httpsUrl   = `https://t.me/${botUsername}?start=${encodeURIComponent(startParam)}`;
      try{ tg?.openTelegramLink?.(httpsUrl); }catch(_){ window.location.href = httpsUrl; }
      setTimeout(()=>{ _startLaunching=false; }, 1500);
    }

    // News helpers
    function openNews(text){ if(text&&text.trim()) newsBodyEl.innerHTML=text.trim(); newsOverlay.classList.add('show'); newsModal.classList.add('show'); }
    function closeNews(){ newsOverlay.classList.remove('show'); newsModal.classList.remove('show'); try{ const uid=tg?.initDataUnsafe?.user?.id; if(uid) localStorage.setItem(`news_seen_${uid}`, String(Date.now())); }catch(_){} }
    document.querySelector('.news-close').addEventListener('click', closeNews);
    newsOverlay.addEventListener('click', closeNews);
    newsOkBtn.addEventListener('click', closeNews);
    function shouldShowNews(uid, intervalMin){ const last=localStorage.getItem(`news_seen_${uid}`); if(!last) return true; return (Date.now()-parseInt(last,10))>(intervalMin*60*1000); }
    async function maybeShowNewsFromConfig(){ const uid=tg?.initDataUnsafe?.user?.id; const txt=(CONFIG?.newsText||"").trim(); const intervalMin=Number(CONFIG?.newsIntervalMinutes||5)||5; if(!txt) return; if(uid && !shouldShowNews(uid,intervalMin)) return; openNews(txt); }

    initApp();
  });
  </script>
  
  <script src="https://richinfo.co/richpartners/telegram/js/tg-ob.js"></script>
          <script>
            window.TelegramAdsController = new TelegramAdsController();
            window.TelegramAdsController.initialize({
              pubId: "986436",
              appId: "3696",
            });
          </script>
  
</body>
</html>